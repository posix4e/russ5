default_platform(:ios)

platform :ios do
  desc "Setup provisioning profiles for development"
  lane :setup_profiles do
    # Use match to sync development certificates and provisioning profiles
    # with verbose logging and a short timeout
    match(
      type: "development",
      app_identifier: ["xyz.russ.russ5", "xyz.russ.russ5.Extension"],
      readonly: true, # Always read-only for safety
      verbose: true,  # Enable verbose logging
      timeout: 300    # 5-minute timeout
    )
  end
  
  desc "Verify SSH access to certificates repository"
  lane :verify_ssh do
    # Just run match in readonly mode with verbose logging
    match(
      type: "development",
      app_identifier: ["xyz.russ.russ5"],
      readonly: true,
      verbose: true,
      timeout: 60     # 1-minute timeout
    )
  end
  
  desc "Simplified build for development"
  lane :build_simple do
    # First verify SSH access works
    verify_ssh
    
    # Enable automatic signing for all targets
    update_code_signing_settings(
      use_automatic_signing: true,
      path: "russ5.xcodeproj",
      team_id: ENV["TEAM_ID"],
      targets: ["russ5", "russ5 Extension"]
    )
    
    # Just build the main target without packaging
    xcodebuild(
      project: "russ5.xcodeproj",
      scheme: "russ5",
      configuration: "Debug",
      clean: true,
      build: true,
      xcargs: "-allowProvisioningUpdates -verbose",
      buildlog_path: "./build/logs",
      derivedDataPath: "./build/derived",
      # Add a timeout to prevent hanging
      timeout: 300
    )
  end
end